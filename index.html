<!DOCTYPE html>

<html>
	<head>
		<title>ConnectLink</title>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<meta name="Description" content="ConnectLink helps improve your social connection. You can easily find a active person in your business network graph.">
		<meta name="Keywords" content="business, person, network, connection, network graph">
		<link href="common/css/main.css" media="all" rel="stylesheet" type="text/css">		
<!-- script -->
<script type="text/javascript" src="http://platform.linkedin.com/in.js">
  api_key: 1m4xzx01cl9p
  onLoad: onLinkedInLoad
  authorize: true
  scope: r_basicprofile r_emailaddress r_network rw_nus
</script>
<script type="text/javascript">
	var app = {
		self: null
		, persons: {}
	};
	// 2. Runs when the JavaScript framework is loaded
	function onLinkedInLoad() {
	     IN.Event.on(IN, "auth", onLinkedInAuth);
	}
	// 2. Runs when the viewer has authenticated
	function onLinkedInAuth() {
	//	alert("hi");
		IN.API.Profile("me").result(displayProfiles);
	}
	// 2. Runs when the Profile() API call returns successfully
	function displayProfiles(profiles) {
	     member = profiles.values[0];
	     document.getElementById("profiles").innerHTML = 
	          "<p id=\"" + member.id + "\">Hello " +  member.firstName + " " + member.lastName + "</p>";
	     app.self = member;
	     IN.API.NetworkUpdates()
     		.params({"type": "CONN", "count": 100}) // get the five most-recent Shares
     		.result(displayNetworkUpdates)
     		.error(displayNetworkUpdatesError);
	}
	function displayNetworkUpdates(updates) {
		console.debug(updates);
		var profileDiv = document.getElementById("networkupdates");
		
		var ids = null;
		var elFaces = document.getElementById("faces");
		var elFaces2nd = document.getElementById("faces-2nd");
		var elActivePersons = document.getElementById("active-persons");
     
		var personIds = new Array();
		var personIds2nd = new Array();
		for (var i in updates.values) {
			var key = updates.values[i].updateKey; // each update has a unique key
			var conn = updates.values[i].updateContent.person; // the person sharing content
			console.debug(conn);
			
			if (undefined != app.persons[conn.id]) {
				app.persons[conn.id].ct++;
			} else {
				// add to array
				app.persons[conn.id] = {
					ct: 1
					, name: "" + conn.firstName + " " + conn.lastName
				}
			}
			
			/* ids and picture (pictureUrl) */
			
			if (-1 == personIds.indexOf(conn.id)) {
				personIds.push(conn.id);
				// avoid error in case of undefined pictureUrl
				if (undefined != conn.pictureUrl) {
					var img = new Image();
					// console.debug(conn.pictureUrl);
					img.src = conn.pictureUrl;
					img.id = "face-" + conn.id;
					img.className = "faceimage";
					elFaces.appendChild(img);
				}
			}
			// console.debug(personIds);
			
			if(conn.connections != undefined) {
				var html = conn.firstName + " " + conn.lastName + " <br/>";
				for (var n = 0; n < conn.connections.values.length; n++) {
					var p = conn.connections.values[n];
					html += "&nbsp;&nbsp;" + p.firstName + " " + p.lastName + ":" + p.headline + "<br/>";
					/* 2nd network faces */
					if (-1 == personIds2nd.indexOf(p.id)) {
						// adding face
						personIds2nd.push(p.id);
						if (undefined != p.pictureUrl) {
							var img = new Image();
							// console.debug(conn.pictureUrl);
							img.src = p.pictureUrl;
							img.id = "face-" + p.id;
							img.className = "faceimage";
							elFaces2nd.appendChild(img);
						}
					}
					
					
				}
				profileDiv.innerHTML += "<p id='" + key + "'>" + html + "</p>";
				/*
				profileDiv.innerHTML += "<p id='" + key + "'>" + share.firstName + " " + share.lastName 
				 + " shared " + share.currentShare.comment + ".</p>";
				 */
			} else {
				/* connect to self */
				var html = conn.firstName + " " + conn.lastName + " <br/>";
				html += "&nbsp;&nbsp;<span class='important'>" + app.self.firstName + " " + app.self.lastName + " </span><br/>";
				profileDiv.innerHTML += "<p id='" + key + "'>" + html + "</p>";
			}
		}// function displayNetworkUpdates
		/*
		 * sort
		 */
		var sArray = new Array();
		for (var k in app.persons) {
			sArray.push({'key':k, ct:app.persons[k].ct});
		}
		sArray.sort(function(a,b){return a.ct - b.ct});
		console.debug(sArray);
		for (var i=0; i < 4; i++) {
			var item = document.createElement('li');
			item.innerHTML = app.persons[sArray[i].key].name;
			
			elActivePersons.appendChild(item);
		}
		
		
	}
	function displayNetworkUpdatesError(error) {
		console.debug(error);
		alert("error occurred");
	}
</script>
<!-- /script -->
		
	</head>
	<body>
		<header class="main">
			<div class="container">
				<div class="logo">ConnectLink.biz</div>
				<div class="elements">
					<!-- 3. Displays a button to let the viewer authenticate -->
					<script type="IN/Login"></script>
					<!-- 4. Placeholder for the greeting -->
					<div id="profiles">
					</div>
				</div>
			</div>
		</header>
		<section id="home-top" class="alternate container">
			<div class="frame">
				Let's activate your network!
			</div>
			<div class="text">
				アクティブな人をあなたのネットワークから探すお手伝いをします。
			</div>
			<div class="right">
				2012年9月 試験運用を開始しました。
			</div>
		</section>
		<section id="home-faces">
			<div class="container">
				<div class="title">1st network</div>
				<div id="faces">
				</div>
			</div>
		</section>
		<section id="home-faces-2nd">
			<div class="container">
				<div class="title">2nd network</div>
				<div id="faces-2nd">
				</div>
			</div>
		</section>
		<section id="home-active">
			<div class="container">
				<h3>Active person</h3>
				<ul id="active-persons" class="person-list">
				</ul>
			</div>
		</section>
		<div id="wrapper">
			<div class="container">
				<div id="networkupdates">
					
				</div>
			</div>
		</div>
		
		<footer class="main">
			<div class="container">
			</div>
		</footer>
		
	</body>
</html>